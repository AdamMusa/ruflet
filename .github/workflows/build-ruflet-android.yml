name: Build Ruflet Client Prebuilds

on:
  workflow_dispatch:
  release:
    types: [published]
  push:
    branches: [main]
    paths:
      - '.github/workflows/build-ruflet-android.yml'
      - 'ruflet_client/**'
  pull_request:
    paths:
      - '.github/workflows/build-ruflet-android.yml'
      - 'ruflet_client/**'

permissions:
  contents: write

jobs:
  build-platforms:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: web
            runner: ubuntu-latest
            artifact: ruflet_client-web.tar.gz
          - target: linux
            runner: ubuntu-latest
            artifact: ruflet_client-linux-x64.tar.gz
          - target: windows
            runner: windows-latest
            artifact: ruflet_client-windows-x64.zip
          - target: macos
            runner: macos-latest
            artifact: ruflet_client-macos-universal.zip

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Linux build deps
        if: matrix.target == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev \
            libsecret-1-dev \
            libmpv-dev mpv \
            libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev \
            gstreamer1.0-plugins-base gstreamer1.0-plugins-good

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install dependencies
        working-directory: ruflet_client
        run: flutter pub get

      - name: Build target
        working-directory: ruflet_client
        run: |
          case "${{ matrix.target }}" in
            web)
              flutter build web --release
              ;;
            linux)
              flutter build linux --release
              ;;
            windows)
              flutter build windows --release
              ;;
            macos)
              flutter build macos --release
              ;;
            *)
              echo "Unsupported target: ${{ matrix.target }}"
              exit 1
              ;;
          esac

      - name: Package artifact (Unix)
        if: matrix.target != 'windows'
        run: |
          case "${{ matrix.target }}" in
            web)
              tar -C ruflet_client/build/web -czf ruflet_client-web.tar.gz .
              ;;
            linux)
              tar -C ruflet_client/build/linux/x64/release/bundle -czf ruflet_client-linux-x64.tar.gz .
              ;;
            macos)
              ditto -c -k --sequesterRsrc --keepParent ruflet_client/build/macos/Build/Products/Release/ruflet_client.app ruflet_client-macos-universal.zip
              ;;
          esac

      - name: Package artifact (Windows)
        if: matrix.target == 'windows'
        shell: pwsh
        run: |
          Compress-Archive -Path ruflet_client/build/windows/x64/runner/Release/* -DestinationPath ruflet_client-windows-x64.zip -Force

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: ruflet_client-${{ matrix.target }}
          path: ${{ matrix.artifact }}

      - name: Attach to GitHub release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ matrix.artifact }}

  build-ios-simulator:
    name: Build iOS Simulator
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install dependencies
        working-directory: ruflet_client
        run: flutter pub get

      - name: Pod install
        working-directory: ruflet_client/ios
        run: pod install --repo-update

      - name: Build iOS simulator
        working-directory: ruflet_client
        run: flutter build ios --simulator --debug --no-codesign

      - name: Package iOS simulator artifact
        run: |
          ditto -c -k --sequesterRsrc --keepParent ruflet_client/build/ios/iphonesimulator/Runner.app ruflet_client-ios-simulator.zip

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: ruflet_client-ios-simulator
          path: ruflet_client-ios-simulator.zip

      - name: Attach to GitHub release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: ruflet_client-ios-simulator.zip

  build-ios-release:
    name: Build iOS Release IPA (Signed)
    if: github.event_name == 'release'
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install dependencies
        working-directory: ruflet_client
        run: flutter pub get

      - name: Import signing certificate and provisioning profile
        env:
          IOS_CERT_P12_BASE64: ${{ secrets.IOS_CERT_P12_BASE64 }}
          IOS_CERT_PASSWORD: ${{ secrets.IOS_CERT_PASSWORD }}
          IOS_PROFILE_BASE64: ${{ secrets.IOS_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          if [ -z "$IOS_CERT_P12_BASE64" ] || [ -z "$IOS_CERT_PASSWORD" ] || [ -z "$IOS_PROFILE_BASE64" ] || [ -z "$KEYCHAIN_PASSWORD" ]; then
            echo "Missing iOS signing secrets. Expected IOS_CERT_P12_BASE64, IOS_CERT_PASSWORD, IOS_PROFILE_BASE64, KEYCHAIN_PASSWORD."
            exit 1
          fi

          CERT_PATH="$RUNNER_TEMP/cert.p12"
          PROFILE_PATH="$RUNNER_TEMP/profile.mobileprovision"
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"

          echo -n "$IOS_CERT_P12_BASE64" | base64 --decode -o "$CERT_PATH"
          echo -n "$IOS_PROFILE_BASE64" | base64 --decode -o "$PROFILE_PATH"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security import "$CERT_PATH" -P "$IOS_CERT_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"

          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          cp "$PROFILE_PATH" "$HOME/Library/MobileDevice/Provisioning Profiles/"

      - name: Build signed IPA
        working-directory: ruflet_client
        run: flutter build ipa --release

      - name: Package iOS release artifact
        run: |
          IPA_PATH=$(find ruflet_client/build/ios/ipa -name "*.ipa" | head -n 1)
          if [ -z "$IPA_PATH" ]; then
            echo "No IPA produced."
            exit 1
          fi
          cp "$IPA_PATH" ruflet_client-ios-release.ipa

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: ruflet_client-ios-release
          path: ruflet_client-ios-release.ipa

      - name: Attach IPA to GitHub release
        uses: softprops/action-gh-release@v2
        with:
          files: ruflet_client-ios-release.ipa

  build-android:
    name: Build Android
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install dependencies
        working-directory: ruflet_client
        run: flutter pub get

      - name: Build Android APK
        working-directory: ruflet_client
        run: flutter build apk --release

      - name: Build Android App Bundle
        working-directory: ruflet_client
        run: flutter build appbundle --release

      - name: Package Android artifacts
        run: |
          cp ruflet_client/build/app/outputs/flutter-apk/app-release.apk ruflet_client-android-apk.apk
          cp ruflet_client/build/app/outputs/bundle/release/app-release.aab ruflet_client-android-appbundle.aab

      - name: Upload workflow artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ruflet_client-android
          path: |
            ruflet_client-android-apk.apk
            ruflet_client-android-appbundle.aab

      - name: Attach to GitHub release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ruflet_client-android-apk.apk
            ruflet_client-android-appbundle.aab
